pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
-- adventure map demo / poc

-- sprites
s_grass=1
s_door=5
s_odoor=6
s_key=7

function _init()
 p={
  --player pos in cels
  x=2,
  y=4,
  s=3,
  g=0,
  i={}
 }
 --current map pos
 m={
  x=0,
  y=0
 }
end

function _update()
 --deltas, intended updates
 --detect collision before
 --applying
 local dx=0
 local dy=0
 if (btnp(0)) dx=-1
 if (btnp(1)) dx=1
 if (btnp(2)) dy=-1
 if (btnp(3)) dy=1
 
 --new x/y or collided pos
 nx=p.x+dx
 ny=p.y+dy
 
 --detect collidables
 tspr=mget(nx,ny)
 if not fget(tspr,0) then
  p.x+=dx
  p.y+=dy
  -- play movement sound
  if dx!=0 or dy != 0 then
   sfx(1)
  end
 end
 
 --detect chest
 if fget(tspr,1) then
  p.g+=100
  sfx(0)
  mset(p.x,p.y,1)
 end
 
 --detect doors
 if tspr == s_door then
  --check key
  if haskey() then
   --change to open door
   mset(nx,ny, s_odoor)
   sfx(2)
   --remove key
   del(p.i,s_key)
  else
   --narp
   sfx(3)
  end
 end
 
 --detect key
 if tspr == s_key then
  add(p.i,s_key)
  sfx(0)
  mset(nx,ny,s_grass)
 end
 
 --map transition
 m.x=flr(p.x/16)
 m.y=flr(p.y/8)
end

function _draw()
 cls()
 --draw current map section
 map(m.x*16,m.y*8,0,0,48,8)
 -- todo: gui or fullscreen map
 --draw player relative to map
 spr(p.s,(p.x%16)*8,(p.y%8)*8)
 
 draw_gui()
end

-- todo: i'm sure there's a 
-- func to check if an array
-- has a key. eh.
function haskey() 
 for i in all(p.i) do
  if (i==s_key) return true
 end
 return false
end
-->8
--ui mgmt

function draw_gui()
 local corner=16
 local horiz=17
 -- todo: can we rotate sprs?
 local vert=32
 
 --corners
 spr(corner,0,64)
 spr(corner,120,64)
 spr(corner,0,120)
 spr(corner,120,120)
 
 --horiz
 for i=1,14 do
   spr(horiz,i*8,64)
   spr(horiz,i*8,120)
 end
 
 --vert
 for i=9,14 do
  spr(vert,0,i*8)
  spr(vert,120,i*8)
 end
 
 --bg
 rectfill(8,72,119,119,5)

 --current gold
 print("gold: "..p.g,12,76,7)
 print("key: ",12,88,7)
 -- key
 if haskey() then
  spr(s_key,28,86)
 end
end
__gfx__
0000000033333b334944494400999900333333335555555555555555333333330000000000000000000000000000000000000000000000000000000000000000
000000003b3333334944494409999990333443335594495554333335333333330000000000000000000000000000000000000000000000000000000000000000
00700700333333339999999909f1ff10334444335494494554433335333aa3330000000000000000000000000000000000000000000000000000000000000000
00077000333333334449444949fffff034444443549449455443333533a33a330000000000000000000000000000000000000000000000000000000000000000
0007700033b33333444944490ccccccc39999993549449a554433335333aa3330000000000000000000000000000000000000000000000000000000000000000
0070070033333b3399999999f0cccc0f344aa4435494494554a33335333a33330000000000000000000000000000000000000000000000000000000000000000
00000000333333334944494400c00c00344444435494494554433335333aa3330000000000000000000000000000000000000000000000000000000000000000
00000000333333334944494400f00f00344444435555555555555555333a33330000000000000000000000000000000000000000000000000000000000000000
55555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888885888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58555585555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58588585858585850000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58588585585858580000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58555585555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58888885888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58585585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58558585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58585585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58558585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58585585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58558585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58585585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58558585000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010002010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101020401070201010202010101010101010101010101010105010101010101010101010101010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101020101010201010202010101010101010101010101010102020101010101020202020102010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101020205020201010202010101010101010101010101010102020101010101020104020102010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101070101010101010101010501010101010101010101010101010102020101010101020102020102010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010202020202020101010101010102020101010101020101010102010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010101010107020101010101010102020101010101020202020202010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020201020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020201020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010101010101010101010101010102020101010101010101010101010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010101010101010101010101010102020101010101010101010101010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010101010101010101010101010102020101010101010101010202020101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010202010101010101070101010101010102020101010101010101010504020101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010101010101010101010101010101010101010101010101010101010202020101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0201010101010101010101010101010101010101010101010101010101010102020101010101010101010101010101020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000700002e5502e400355500000000000000003200032000350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000900000a05003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000e000027150291502a1502b1502b1402b1302b1202b110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000a00001315013150131001310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
