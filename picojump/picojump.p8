pico-8 cartridge // http://www.pico-8.com
version 18
__lua__
function _init()
 px=20
 py=64
 pstate=0
 pspr=1
 pdir=0
 
 pat=0 --state clocc
 mapx=0 -- map x offset
end

function _update()
 b0=btn(0)
 b1=btn(1)
 b2=btn(2)
 
 pat+=1 --inc state clock

 -- states
 -- idle
 if pstate==0 then
  pspr=1
  if (b0 or b1) change_state(1)
  if (b2) change_state(3)
  if (canfall()) change_state(2) 
 end

 -- walk state
 if pstate==1 then
  if (b0) pdir=-1
  if (b1) pdir=1
  -- x pos accelleration
  -- only 1 frame though?
  px+=pdir*min(pat,2)
  -- change anim on every 2nd pat frame
  pspr=(flr(pat/2)%2) + 1

  -- go to idle if no buttons pressed  
  if (not (b0 or b1)) change_state(0)
  -- jump state if hitting jump
  if (b2) change_state(3)
  if (canfall()) change_state(2)
 end
 
 -- fall state
 if pstate==2 then
  pspr=2
  if (canfall()) then
   -- steer in midair
   if (b0) px-=1
   if (b1) px+=1
   -- move player down up to spd 4
   py+=min(4,pat)
   
   -- check ground contact
   -- round py to 8ths
   if (not canfall()) py=flr(py/8)*8
  else
   -- landed, switch state
   -- fix position when we hit ground
   py=flr(py/8)*8
   change_state(0)
  end
 
 end
 
 --jump state
 --probably needs collision
 if pstate==3 then
  pspr=2
  py-=6-pat
  if (b0) px-=2
  if (b1) px+=2
  if (not b2 or pat>7) change_state(0)
 end

 --avoid going off map
 if px <= 0 then
  px=max(px,0)
 end
 
 -- adjust mapx right
 if px - mapx > 80 then
  mapx+=2
 end
 
 if px - mapx <= 20 then
  mapx = max(mapx-2,0)
 end
end

function _draw()
 cls()
 map(0,0,0,0,32,16)
 camera(mapx,0)
 -- tip: last arg is mirror
 spr(pspr,px,py,1,1,pdir==-1)
 print(px.."-"..mapx.." diff "..px-mapx,5 + mapx,5)
end

function canfall()
 -- get map tile under player
 -- get the map tile under the player
 v=mget(flr((px+4)/8),flr((py+8)/8)) -- see if itââ–ˆâ–¥s flagged as wall
 return not fget(v,0)
end

function change_state(s)
 pstate=s
 pat=0
end
__gfx__
0000000000bbbb0000bbbb0000b77b00ccccccccccccccccccc077cc800000000000000000000000000000000000000000000000000000000000000000000000
000000000bb77bb00bb77bb00bb70bb0cccccccccccccc77cc07777c800000000000000000000000000000000000000000000000000000000000000000000000
007007000bb70bb00bb70bb00bbbbbb0ccccccccccccc0777c07777c800000000000000000000000000000000000000000000000000000000000000000000000
000770000bbbbbb00bbbbbb00b33bbb0cccccccccc77777777777777800000000000000000000000000000000000000000000000000000000000000000000000
000770000bb3bb000bb3bb0003bbbb00cccccccccc7077777007777c800000000000000000000000000000000000000000000000000000000000000000000000
0070070000b3bb00004b3b00000bbb00ccccccccccc700077770007c800000000000000000000000000000000000000000000000000000000000000000000000
00000000000bb0000044bb220022b000cccccccccccc7777cc77777c800000000000000000000000000000000000000000000000000000000000000000000000
00000000004444000111022000002200cccccccccccccccccccccccc800000000000000000000000000000000000000000000000000000000000000000000000
ffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaaaaaaacaaaaaaaaaaaaaac00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999c99999999999999c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999c99999999999999c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cc999999999999cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999cc999999999999cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444cc444444444444cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222cc222222222222cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0406040404040404040404040404040404040404040405060404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040604040404040506040404040404040410040404040404040404040404040506040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404041010101004040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040411120404040404040404041004040404050604040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404041112040404041112040404040404040404041004040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040411101204040404040404041010101004040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404101004040404040404040404040404101010040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010100404040404040404041010101010040404040404041010100404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040410101004040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404101004040404040404040404040407040404040404040404101010040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040411101010101010101010101010101010101010100404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040405060404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0410101010040404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100201f7501c75022750277502a75028750257501c7501b7501c75013750117500d7500d7500275002750067501b7500d7501b7501a7501b7501b7502175013750137501c7501b7501a7501c750207501c750
